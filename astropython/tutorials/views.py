from django.shortcuts import render,HttpResponseRedirect,Http404

import random
from slugify import slugify
import datetime

from django.core.urlresolvers import reverse
from .forms import HeaderForm,TailForm,WYSIWYGCodeBody,WYSIWYGTutorialBody,MarkdownCodeBody,MarkdownTutorialBody,WYSIWYGResourceBody,MarkdownResourceBody
from .models import Tutorial,CodeSnippet,EducationalResource,TutorialSeries,SeriesTutorial

"""
Tutorial Creation Wizard comprises of 3 steps :
    The first step (or start_step) create the basic models and provides initial information to create the models , namely the title,abstract and preferred input mode
    The second step (or intermediate_step) fills up the rest of the information - body,extra info, etc
    The final step (or finish_step) adds the tags and categories to the model and will in the future include sharing on social network abilities
"""
name=""
def start_step(request,model,**kwargs):
    global name
    if(model==Tutorial):
        name="Tutorial"
    elif(model==CodeSnippet):
        name="Code Snippet"
    elif(model==EducationalResource):
        name="Educational Resource"
    elif(model==SeriesTutorial):
        name="Tutorial for Series"
        obj=TutorialSeries.objects.get(slug=kwargs['slug'])
    elif(model==TutorialSeries):
        name="Tutorial Series"
    if request.method == 'POST':
        form = HeaderForm(request.POST)
        if form.is_valid():
            model_instance = model()
            model_instance.title=form.cleaned_data['title']
            model_instance.abstract=form.cleaned_data['abstract']
            model_instance.input_type=form.cleaned_data['input_type']
            model_instance.slug=slugify(form.cleaned_data['title'])#Add a check to see if slug is always unique
            if(model==SeriesTutorial):
                print TutorialSeries.objects.get(slug=kwargs['slug'])
                model_instance.tut_series=obj
            model_instance.save()
            model_instance.authors.add(request.user) #Add anonymous user config
            model_instance.save()
            url='creation_intermediate_'+(str(model.__name__)).lower()
            if(model==TutorialSeries):
                return HttpResponseRedirect(reverse('home'))
            elif(model==SeriesTutorial):
                return HttpResponseRedirect(reverse(url,kwargs={'slug':model_instance.slug,'slug_series':obj.slug}))
            else:
                return HttpResponseRedirect(reverse(url,kwargs={'slug':model_instance.slug}))

    return render(request,'tutorials/creation.html',{'form':HeaderForm,'name':name})

def intermediate_step(request,slug,model,**kwargs):
    obj=model.unmoderated_objects.get(slug=slug)
    if (model==Tutorial or model==SeriesTutorial):
        if (obj.input_type=="WYSIWYG"):
            FormType=WYSIWYGTutorialBody
        else:
            FormType=MarkdownTutorialBody
    elif(model==CodeSnippet):
        if (obj.input_type=="WYSIWYG"):
            FormType=WYSIWYGCodeBody
        else:
            FormType=MarkdownCodeBody
    elif(model==EducationalResource):
        if (obj.input_type=="WYSIWYG"):
            FormType=WYSIWYGResourceBody
        else:
            FormType=MarkdownResourceBody
    if request.method == 'POST':
        form= FormType(request.POST)
        if form.is_valid():
            obj.body = form.cleaned_data['body']
            if (model==CodeSnippet):
                obj.snippet = form.cleaned_data['snippet']
            elif (model==EducationalResource):
                obj.start_date = datetime.datetime.strptime(form.cleaned_data['start_date'],"%Y-%m-%d")
                obj.instructor_names =form.cleaned_data['instructor_names']
                obj.website = form.cleaned_data['website']
                obj.background=form.cleaned_data['background']
                obj.language=form.cleaned_data['language']
            obj.save()
            url='creation_finish_'+(str(model.__name__)).lower()
            if(model==SeriesTutorial):
                return HttpResponseRedirect(reverse('home'))
            return HttpResponseRedirect(reverse(url,kwargs={'slug':obj.slug}))

    return render(request,'tutorials/creation.html',{'form':FormType,'name':name})

def finish_step(request,slug,model):
    obj=model.unmoderated_objects.get(slug=slug)
    if request.method=='POST':
        form = TailForm(request.POST,instance=obj)
        instance=form.save(commit=False)
        form.save_m2m()
        return HttpResponseRedirect(reverse('home'))
    return render(request,'tutorials/creation.html',{'form':TailForm,'name':name})

"""
To view a single model instance
"""
def single(request,model,slug,**kwargs):
    try:
        obj=model.objects.get(slug=slug)
        context = {'obj':obj}
        return render(request,'tutorials/single.html',context)
    except:
        raise Http404